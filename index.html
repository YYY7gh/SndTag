<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mainButton = document.getElementById('mainButton');
        const upgradeButton = document.getElementById('upgradeButton');
        const sound = document.getElementById('funSound');
        const coinCount = document.getElementById('coinCount');
        const coinIcon = document.getElementById('coinIcon');
        const skinPanelToggle = document.getElementById('skinPanelToggle');
        const skinPanel = document.getElementById('skinPanel');
        const skinOptions = document.querySelectorAll('.skin-option');

        // Load saved values from localStorage
        let count = parseInt(localStorage.getItem('coinCount')) || 0;
        let coinsPerClick = parseInt(localStorage.getItem('coinsPerClick')) || 1;
        let upgradeLevel = parseInt(localStorage.getItem('upgradeLevel')) || 1;
        let upgradeCost = Math.floor(10 * Math.pow(upgradeLevel, 2));
        let currentSkin = localStorage.getItem('currentSkin') || 'Skins/SvetlanaSkin.jpg'; // Default to Svetlana
        let unlockedSkins = JSON.parse(localStorage.getItem('unlockedSkins')) || ['Skins/SvetlanaSkin.jpg']; // Svetlana is free and unlocked by default

        // Apply initial skin
        mainButton.style.backgroundImage = `url('${currentSkin}')`;
        upgradeButton.style.backgroundImage = `url('${currentSkin}')`;
        coinIcon.src = currentSkin;

        // Initialize display
        coinCount.textContent = count;
        upgradeButton.textContent = `Upgrade (${upgradeCost} coins)`;
        upgradeButton.disabled = count < upgradeCost;

        // Update skin options based on unlocked status
        skinOptions.forEach(option => {
            const skin = option.getAttribute('data-skin');
            if (!unlockedSkins.includes(skin)) {
                option.classList.add('locked');
            }
        });

        mainButton.addEventListener('click', function(e) {
            sound.volume = 1.0;
            sound.play()
                .catch((e) => console.error('Ошибка воспроизведения звука:', e));

            count += coinsPerClick;
            coinCount.textContent = count;
            localStorage.setItem('coinCount', count);

            const coin = document.createElement('img');
            coin.src = currentSkin;
            coin.className = 'flying-coin';
            const rect = mainButton.getBoundingClientRect();
            coin.style.left = (e.clientX - rect.left - 15) + 'px';
            coin.style.top = (e.clientY - rect.top - 15) + 'px';
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 1200);

            upgradeButton.disabled = count < upgradeCost;
            updateSkinOptions();
        });

        upgradeButton.addEventListener('click', function() {
            if (count >= upgradeCost) {
                count -= upgradeCost;
                coinsPerClick += 1;
                upgradeLevel++;
                
                upgradeCost = Math.floor(10 * Math.pow(upgradeLevel, 2));
                upgradeButton.textContent = `Upgrade (${upgradeCost} coins)`;
                
                coinCount.textContent = count;
                upgradeButton.disabled = count < upgradeCost;

                localStorage.setItem('coinCount', count);
                localStorage.setItem('coinsPerClick', coinsPerClick);
                localStorage.setItem('upgradeLevel', upgradeLevel);
                updateSkinOptions();
            }
        });

        // Toggle skin panel
        skinPanelToggle.addEventListener('click', function() {
            skinPanel.style.display = skinPanel.style.display === 'block' ? 'none' : 'block';
        });

        // Handle skin selection
        skinOptions.forEach(option => {
            option.addEventListener('click', function() {
                const skin = this.getAttribute('data-skin');
                const cost = parseInt(this.getAttribute('data-cost'));

                if (unlockedSkins.includes(skin)) {
                    // Apply skin if already unlocked
                    currentSkin = skin;
                    mainButton.style.backgroundImage = `url('${currentSkin}')`;
                    upgradeButton.style.backgroundImage = `url('${currentSkin}')`;
                    coinIcon.src = currentSkin;
                    localStorage.setItem('currentSkin', currentSkin);
                    skinPanel.style.display = 'none';
                } else if (count >= cost) {
                    // Unlock and apply skin if affordable
                    count -= cost;
                    unlockedSkins.push(skin);
                    currentSkin = skin;
                    mainButton.style.backgroundImage = `url('${currentSkin}')`;
                    upgradeButton.style.backgroundImage = `url('${currentSkin}')`;
                    coinIcon.src = currentSkin;
                    coinCount.textContent = count;
                    localStorage.setItem('coinCount', count);
                    localStorage.setItem('unlockedSkins', JSON.stringify(unlockedSkins));
                    localStorage.setItem('currentSkin', currentSkin);
                    this.classList.remove('locked');
                    skinPanel.style.display = 'none';
                }
            });
        });

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            if (!skinPanel.contains(e.target) && e.target !== skinPanelToggle) {
                skinPanel.style.display = 'none';
            }
        });

        // Function to update skin option states
        function updateSkinOptions() {
            skinOptions.forEach(option => {
                const skin = option.getAttribute('data-skin');
                const cost = parseInt(option.getAttribute('data-cost'));
                if (!unlockedSkins.includes(skin) && count < cost) {
                    option.classList.add('locked');
                } else {
                    option.classList.remove('locked');
                }
            });
        }
    });
</script>
